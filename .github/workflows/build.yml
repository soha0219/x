# .github/workflows/build.yml (已修复并优化)

name: Build X-Link CLI Kernel

# 【核心修复】: 
# 添加 push 事件触发器。
# 现在，每当有代码被推送到 main 分支时，此工作流程都会自动运行。
# 同时保留 workflow_dispatch，以便您仍然可以手动触发。
on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: Build for windows
    runs-on: ubuntu-latest # 我们只构建 Windows 版本，所以可以简化 strategy

    steps:
      - name: Checkout Code
        # 使用 v4 版本，确保拉取的是触发本次工作流程的最新代码
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23' 

      # 【优化步骤】: 将依赖处理合并到构建前，更加清晰
      - name: Download Go Modules
        run: go mod tidy

      - name: Build CLI Binary
        env:
          GOOS: windows
          GOARCH: amd64
          CGO_ENABLED: 0
        run: |
          # 编译目标是 ./cmd/xlink-cli
          go build -trimpath -ldflags="-s -w" -o xlink-cli.exe ./cmd/xlink-cli

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: xlink-cli-windows-amd64
          path: xlink-cli.exe
